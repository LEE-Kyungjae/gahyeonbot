name: Rollback

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Rollback target (blue, green, auto)"
        required: false
        default: "auto"

permissions:
  contents: read

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Upload rollback script
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "scripts/remote-rollback.sh"
          target: "/tmp"
      - name: Execute rollback
        uses: appleboy/ssh-action@v1.0.2
        env:
          SPRING_PROFILES_ACTIVE: prod
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: SPRING_PROFILES_ACTIVE
          script: |
            set -euo pipefail
            chmod +x /tmp/scripts/remote-rollback.sh
            /tmp/scripts/remote-rollback.sh "${{ github.event.inputs.target }}"
